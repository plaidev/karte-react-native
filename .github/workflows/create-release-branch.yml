name: "Create release branch"
on:
  workflow_dispatch: # Should be executed manually.
jobs:
  create-release:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    # Should be executed on the dev repo.
    if: github.repository != 'plaidev/karte-react-native'
    permissions:
      contents: write
    steps:
      - name: Generate GitHub App token
        uses: actions/create-github-app-token@7e473efe3cb98aa54f8d4bac15400b15fad77d94 # v2.2.0
        id: app-token
        with:
          app-id: ${{ secrets.APP_TEAM_GITHUB_APP_ID }}
          private-key: ${{ secrets.APP_TEAM_GITHUB_APP_PRIVATE_KEY }}
          owner: plaidev
          repositories: |
            karte-react-native-dev
            karte-react-native-tools
      - name: Checkout develop
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: develop
      - name: Configure Git
        run: |
          git config user.email "git@users.noreply.github.com"
          git config user.name "github actions"
          git fetch
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y.%m.%dT%H.%M.%S')" >> $GITHUB_OUTPUT
      - name: Create and push release branch
        run: |
          git checkout -b release/${{ steps.date.outputs.date }}
          git push origin -u release/${{ steps.date.outputs.date }}
      - name: Create Pull Request
        id: create_pr
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          PR_BODY: |
            ### 以下の項目を確認してください
            - [ ] `package.json`内のバージョンならびに`CHANGELOG.md`が更新されていることを確認した。
            - [ ] サンプルアプリで動作確認を行った。
            - [ ] 全てのチェックボックスを埋めると自動的にマージ作業を開始します。
        run: |
          PR_URL=$(gh pr create \
            --title "Release by ${{ github.actor }}" \
            --body "$PR_BODY" \
            --base master \
            --head release/${{ steps.date.outputs.date }})
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
      - name: Trigger deploy-test-expo-app (iOS)
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          gh workflow run deploy-test-expo-app-ios.yml \
            --repo plaidev/karte-react-native-tools \
            --field sdk_branch=release/${{ steps.date.outputs.date }} \
            --field expo_plugin_branch=main
      - name: Trigger deploy-test-expo-app (Android)
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          gh workflow run deploy-test-expo-app-android.yml \
            --repo plaidev/karte-react-native-tools \
            --field sdk_branch=release/${{ steps.date.outputs.date }} \
            --field expo_plugin_branch=main
      - name: Notify Slack on success
        if: success()
        uses: rtCamp/action-slack-notify@e31e87e03dd19038e411e38ae27cbad084a90661 # v2.3.3
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_MESSAGE: |
            ✅ Successfully created release branch
            PR: ${{ steps.create_pr.outputs.pr_url }}
          SLACK_COLOR: success
      - name: Notify Slack on failure
        if: failure()
        uses: rtCamp/action-slack-notify@e31e87e03dd19038e411e38ae27cbad084a90661 # v2.3.3
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_MESSAGE: |
            ❌ Failed to create release branch
          SLACK_COLOR: failure
